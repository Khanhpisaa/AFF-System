<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh Toán Đơn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
    <h2 class="text-center mb-4">Xác Nhận Đơn Hàng</h2>

    <form th:action="@{/thanh-toan/mua}" method="post" id="thanhToanForm">
        <div class="row g-4">

            <!-- Thông tin người nhận -->
            <div class="col-md-6">
                <div class="card shadow rounded-4 p-4">
                    <h5 class="mb-3">Thông Tin Người Nhận</h5>

                    <div class="mb-3">
                        <label class="form-label">Tên người nhận:</label>
                        <input type="text" class="form-control" name="tenNguoiNhan"
                               th:value="${nguoiDung.hoTen}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Địa chỉ giao hàng:</label>
                        <input type="text" class="form-control" name="diaChiGiaoHang"
                               th:value="${diaChiGiaoHang}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ghi chú:</label>
                        <textarea class="form-control" name="ghiChu" rows="3"
                                  th:text="${ghiChu}"></textarea>
                    </div>
                </div>
            </div>

            <!-- Chi tiết đơn hàng -->
            <div class="col-md-6">
                <div class="card shadow rounded-4 p-4">
                    <h5 class="mb-3">Chi Tiết Đơn Hàng</h5>

                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${gioHang}">
                                <td th:text="${item.tenSanPham}"></td>
                                <td th:text="${item.soLuong}"></td>
                                <td th:text="${item.gia}"></td>
                                <td th:text="${item.soLuong != null and item.gia != null ? item.soLuong * item.gia : 0}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="text-end mt-3">
                        <h5>Tổng tiền:
                            <span class="text-danger fw-bold"
                                  id="tongTienText"
                                  th:text="${tongTien}"></span> đ
                        </h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phương thức thanh toán -->
        <div class="card shadow rounded-4 p-4 mt-4">
            <h5 class="mb-3">Phương Thức Thanh Toán</h5>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="cashOption" value="cash" checked onchange="handlePaymentChange()">
                <label class="form-check-label" for="cashOption">Tiền mặt</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="bankOption" value="bank" onchange="handlePaymentChange()">
                <label class="form-check-label" for="bankOption">Chuyển khoản</label>
            </div>

            <!-- Nhập tiền mặt -->
            <div id="cashInputSection" class="mt-3">
                <label class="form-label">Tiền khách đưa:</label>
                <input type="number" class="form-control" id="tienKhachDua" oninput="tinhTienThoiLai()" placeholder="Nhập số tiền khách đưa" required>
                <div class="mt-2 text-success fw-bold">
                    Tiền thối lại: <span id="tienThoiLai">0</span> đ
                </div>
            </div>

            <!-- QR chuyển khoản -->
            <div id="bankTransferSection" class="mt-3" style="display: none;">
                <label class="form-label">Mã QR Chuyển Khoản:</label>
                <div>
                    <img src="/images/qr.jpg" alt="QR Code" width="200">
                </div>
            </div>
        </div>

        <!-- Nút hành động -->
        <div class="d-flex justify-content-between mt-4">
            <a href="/" class="btn btn-outline-secondary">Quay lại</a>
            <button type="submit" class="btn btn-success">Xác Nhận Thanh Toán</button>
        </div>
    </form>
</div>

<!-- Script -->
<script>
    function handlePaymentChange() {
        const isCash = document.getElementById('cashOption').checked;
        const cashInput = document.getElementById('cashInputSection');
        const bankTransfer = document.getElementById('bankTransferSection');
        const tienKhachInput = document.getElementById('tienKhachDua');

        cashInput.style.display = isCash ? 'block' : 'none';
        bankTransfer.style.display = isCash ? 'none' : 'block';

        tienKhachInput.required = isCash;
    }

    function tinhTienThoiLai() {
        const tongTienText = document.getElementById('tongTienText').textContent.replace(/[^\d]/g, '');
        const tongTien = parseInt(tongTienText || "0");
        const tienKhachDua = parseInt(document.getElementById('tienKhachDua').value || "0");
        const tienThoi = tienKhachDua - tongTien;

        document.getElementById('tienThoiLai').innerText = tienThoi > 0 ? tienThoi.toLocaleString() : 0;
    }

    document.getElementById("thanhToanForm").addEventListener("submit", function (e) {
        const isCash = document.getElementById('cashOption').checked;

        if (isCash) {
            const tongTienText = document.getElementById('tongTienText').textContent.replace(/[^\d]/g, '');
            const tongTien = parseInt(tongTienText || "0");
            const tienKhachDua = parseInt(document.getElementById('tienKhachDua').value || "0");

            if (tienKhachDua < tongTien) {
                alert("Tiền khách đưa chưa đủ để thanh toán!");
                e.preventDefault();
            }
        }
    });
</script>
</body>
</html>
